<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title>Document</title>

	<link rel="stylesheet" href="/css/style.css">

</head>

<body>

	<div id="chat">
		<ul id="rooms"></ul>
		<div id="messages">
			<ul id="messages_body"></ul>
			<div id="messages_form">
				<form id="messages_form_self" action="">
					<input type="text" id="message" placeholder="message" autocomplete="off"/>
					<button type="submit">Send</button>
				</form>
			</div>
		</div>
	</div>

	<script id="room_template" type="text/template">
		<li data-id={{id}} class="room_item">{{name}}</li>
	</script>

	<script id="message_template" type="text/template">
		<li class="message_item {{position}}">
			<div>
				<b>{{sender}}:</b> {{text}} <i>{{time}}</i>
			</div>
		</li>
	</script>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="/socket.io/socket.io.js"></script>
	<script src="/js/axios.min.js"></script>
	<script src="/js/mustache.js"></script>
	<script src="/js/moment.js"></script>
	<script>

		var userId = prompt('Enter id: \n Pavlo: 1 \n Igor: 2 \n Jenya: 3');

		axios.get('/rooms', {
			params: {
				user_id: userId
			}
		}).then(function (response) {
			response.data.forEach(function (el) {
				var template = $('#room_template').html();
				var html = Mustache.render(template, {
					name: el.name,
					id: el.id
				});
				$('#rooms').append(html);
			})
		}).catch(function (error) {
			console.log(error);
		});

		$(function () {
			var socket = io();
			var activeRoom = false;

			socket.on('newMessage', function (data) {
				var html = generateMessage(data);
				$('#messages_body').append(html);
				scrollToBottom();
			});

			$('body').on('click', '.room_item', function () {

				$('#messages').css('visibility', 'visible');
				$('#messages_body').empty();

				var activeDay;
				var id = this.dataset.id;

				socket.emit('joinRoom', {
					prevRoom: activeRoom,
					room: id
				});

				activeRoom = id;

				axios.get('/messages', {
					params: {
						room_id: id
					}
				}).then(function (response) {
					response.data.forEach(function (el) {
						var html = generateMessage(el);

						$('#messages_body').prepend(html);
					
						scrollToBottom();
					});
				}).catch(function (error) {
					console.log(error);
				});
			});

			$('#messages_form_self').submit(function (e) {
				e.preventDefault();
				socket.emit('createMessage', {
					text: $('#message').val(),
					room: activeRoom,
					id_sender: userId
				});

				this.reset();

			});

			function generateMessage(data) {
				var template = $('#message_template').html();
				// console.log(data)
				return Mustache.render(template, {
					text: data.text,
					sender: data.username,
					time: moment(data.created_at).format('h:mm a'),
					position: data.id_sender === userId ? 'right my_message' : 'left'
				});
			}

			function scrollToBottom() {
				var messages = $('#messages_body');
				var newMessage = messages.children('li:last-child');
				var clientHeight = messages.prop('clientHeight');
				var scrollTop = messages.prop('scrollTop');
				var scrollHeight = messages.prop('scrollHeight');
				var newMessageHeight = newMessage.innerHeight();
				var lastMessageHeight = newMessage.prev().innerHeight();

				if (clientHeight + scrollTop + newMessageHeight + lastMessageHeight >= scrollHeight) {
					messages.scrollTop(scrollHeight);
				}

			}

		});

	</script>

</body>

</html>